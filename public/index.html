<!DOCTYPE html>
<head>
  <title>Spoggy / Solid / Socket.IO</title>
  <!-- GENERAL LIBRAIRIES -->
  <script src="/socket.io/socket.io.js"></script>
  <script src="lib/rdflib.min.js"></script>
  <script src="lib/solid-auth-client.bundle.js"></script>

  <script>
  var host = window.document.location.host;
  var socket = io(host);
  socket.on('connect', function(){
    console.log("connecte");
  });
  socket.on('event', function(data){
    console.log(data);
  });
  socket.on('disconnect', function(){
    console.log("deconnecte");
  });
  //console.log(socket);
  </script>

  <script>
  //  console.log($rdf);
  //  console.log(solid)
</script>

<style>
li:nth-child(even) {
    background: #FF0;
}
li:nth-child(odd) {
    background: #CCC;
}
</style>


</head>
<body>

  <div>
    <p>
      <button id="solidLogin"  onclick="login()">Login</button>
    </p>
    <p>
      <button id="solidLogout"  onclick="logout()">Logout</button>
    </p>
    <p>
      (<a href="https://solid.inrupt.com/get-a-solid-pod" target="_blank"> Get a POD / Obtenir un POD</a>)
    </p>
  </div>

  <div id="card">
    Pod : <input id="podInput" type="text" size="100"></input>
    <br>
    Name : <input id="nameInput" type="text" size="100"></input>
    <p>
      <button id="updatePublicFolderBtn"  onclick="updatePublicFolder()">update Public Folder / Actualiser le dossier public</button>
    </p>


    <table border="1" width="90%">
      <tr><th width="50%">Folders</th><th>Files</th></tr>
      <tr>
        <td>
          <ul id="foldersList"></ul>
        </td>
        <td>
          <ul id="filesList"></ul>
        </td>
      </tr>
    </table>
  </div>
</body>


<script>
const podInput = document.getElementById('podInput');
const nameInput = document.getElementById('nameInput');
const solidLogin = document.getElementById('solidLogin');
const solidLogout = document.getElementById('solidLogout');

//namespaces
const FOAF = new $rdf.Namespace('http://xmlns.com/foaf/0.1/');
const LDP = new $rdf.Namespace('http://www.w3.org/ns/ldp#>');

const store  = $rdf.graph();
var sess, webidRoot, publicFolder, folder, fetcher, updater;
var folders = [];
var files = [];

function login(){
  console.log("login")
  console.log(solid);
  // Log the user in and out on click
  const popupUri = 'popup.html';
  solid.auth.popupLogin({Â popupUri });
}

function logout(){
  console.log("logout")
  solid.auth.logout();
  //  this._clearSolidResults();
}


solid.auth.trackSession(session => {
  const loggedIn = !!session;


  if (loggedIn){
    console.log("LOGGED : ",session.webId)
    solidLogin.style.display = "none";
    solidLogout.style.display = "block";
    card.style.display = "block";

    podInput.value = session.webId;
    sess = session;

    var uri = podInput.value;
    console.log(uri);
    const me = store.sym(uri);
    const profile = me.doc();       //i.e. store.sym(''https://example.com/alice/card#me')

    console.log(me)
    console.log(profile)
    fetcher = new $rdf.Fetcher(this.store);
    updater = new $rdf.UpdateManager(this.store);
    console.log(fetcher)
    console.log(updater)
    /*
    updatePublicFolder()
    */
    loadProfile();
  }else{
    console.log("NOT LOGGED");
    solidLogin.style.display = "block";
    solidLogout.style.display = "none";
    card.style.display = "none";

    podInput.value = "";
    nameInput.value = "";
    webidRoot = null;
    fetcher = null;
    updater = null;
    publicFolder = null;
    sess = null;
    /*clearPublicFolder*/
  }
});

function loadProfile(){
  const store = $rdf.graph();
  const me = store.sym(sess.webId);
  const profile = me.doc() //    i.e. store.sym(''https://example.com/alice/card#me');
  const VCARD = new $rdf.Namespace('http://www.w3.org/2006/vcard/ns#');
  const fetcher =new $rdf.Fetcher(store);
  fetcher.load(profile).then(response => {
    let name = store.any(me, VCARD('fn'));
    console.log("Loaded "+name);
    nameInput.value = name;
  }, err => {
    console.log("Load failed" +  err);
  });

}



function updatePublicFolder(folder){
  if (folder == undefined){
    var wedIdSpilt = sess.webId.split("/");
    console.log(wedIdSpilt);
    wedIdRoot = wedIdSpilt[0]+"//"+wedIdSpilt[2]+"/"

    publicFolder = wedIdRoot+"public/";
    console.log(publicFolder);
    folder = publicFolder;
  }
  console.log("FOLDERS SEARCH"+folder )
  document.getElementById("foldersList").innerHTML = ""
  document.getElementById("filesList").innerHTML = ""
  console.log(folder)

  const store = $rdf.graph();
  const me = store.sym(sess.webId);
  const profile = me.doc() //    i.e. store.sym(''https://example.com/alice/card#me');

  //NAMESPACES https://github.com/solid/solid-ui/blob/master/src/ns.js
  const VCARD = new $rdf.Namespace('http://www.w3.org/2006/vcard/ns#');
  const RDF = new $rdf.Namespace('http://www.w3.org/1999/02/22-rdf-syntax-ns#');
  const LDP = new $rdf.Namespace('http://www.w3.org/ns/ldp#>');
  const STAT = new $rdf.Namespace('http://www.w3.org/ns/posix/stat#')
  const fetcher =new $rdf.Fetcher(store);
  fetcher.load(folder).then(response => {
    console.log(response.responseText)
    //console.log(fetcher)
    let all = store.match(null, null, null, null);
    console.log(all)

    let sizes = store.match(null, STAT('size'), null, null);
    console.log(sizes);
    sizes.forEach(function(s){
      if (s.object.value == '4096'){
        console.log('folder '+s.subject.value);
        folders.push(s.subject.value);
        var li = document.createElement("li");
        li.addEventListener("click", function(){updatePublicFolder(s.subject.value)});
        var text = document.createTextNode(s.subject.value);
        li.appendChild(text);
        document.getElementById("foldersList").appendChild(li);
      }else{
        console.log('file '+s.subject.value);
        files.push(s.subject.value);
        var li = document.createElement("li");
        var text = document.createTextNode(s.subject.value);
        li.appendChild(text);
        document.getElementById("filesList").appendChild(li);
      }
    });
    console.log("Folders: "+folders);
    console.log("Files: "+files);

    //  var slides = ["slide 1", "slide 2", "slide 3", "slide 4", "slide 5"]
    /*  var foList = '<ul>';
    folders.forEach(function(f) {
    foList += '<li>'+ f + '</li>';
  });
  foList += '</ul>';
  document.getElementById("foldersList").innerHTML = foList;

  var fiList = '<ul>';
  files.forEach(function(f) {
  fiList += '<li>'+ f + '</li>';
});
fiList += '</ul>';
document.getElementById("filesList").innerHTML = fiList;*/

/*let m = store.match(null, RDF('type'), null, null);
console.log(m)
let f = store.any(null, LDP('contains'));
console.log("Loaded M "+f);*/
//  nameInput.value = name;
}, err => {
  console.log("Load failed" +  err);
});

/*
fetcher.load(folder).then(function(f) {
console.log(f);
//let files = store.any(folder, LDP('contains'));
let files = store.any(folder);
console.log(files)
files.forEach(function(file) {
console.log('contains' + file);
});
});*/
}

/*
function extractHostname(urlLong) {
var hostname;
//find & remove protocol (http, ftp, etc.) and get hostname

if (urlLong.indexOf("//") > -1) {
hostname = urlLong.split('/')[2];
}
else {
hostname = urlLong.split('/')[0];
}

//find & remove port number
hostname = hostname.split(':')[0];
//find & remove "?"
hostname = hostname.split('?')[0];

return hostname;
}*/



</script>

</html>
